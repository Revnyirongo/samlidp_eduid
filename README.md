# samlidp

This repository contains the simplified code of samlidp.io. It is focused on what NRENs need, so you can host a SAML Identity Provider as a Service for institutes in minutes. The new local Docker workflow below gives you a batteries-included development setup with PostgreSQL, self-signed IdP certificates, database migrations, seeding, health checks, and automated tests.

## Quick Start (Local Docker Dev)

**Prerequisites**
- Docker 24+
- Docker Compose v2
- GNU Make (optional but recommended)

**Steps**
1. `make env`
2. `make certs`
3. `make up`
4. Visit http://localhost:8080/health and http://localhost:8080/saml/metadata
5. `make test`

The compose stack builds a PHP 7.3 container, installs composer dependencies on boot, waits for PostgreSQL, runs lightweight SQL migrations, seeds a demo user, and finally serves the Symfony app on `0.0.0.0:8080`.

## Configuration

Environment variables live in `.env` (copied from `.env.example`). Key values:

| Variable | Purpose |
|----------|---------|
| `APP_HOST` / `APP_PORT` | Bind address/port for the PHP built-in server. |
| `POSTGRES_*` | Credentials and connection info for the bundled PostgreSQL 16 container. |
| `DATABASE_URL` | Connection string read by migration/seed scripts. |
| `SAMLIDP_HOSTNAME` | Base domain used to resolve tenants (e.g. `eduid.africa`). |
| `SAMLIDP_TRUSTED_DOMAINS` | Optional space/comma-separated list of additional trusted redirect domains. |
| `SAML_IDP_ENTITY_ID` | EntityID exposed in the metadata endpoint. |
| `SAML_IDP_SSO_URL` | Location used for the stubbed SSO endpoint. |
| `SAML_IDP_CERT_PATH` / `SAML_IDP_KEY_PATH` | Paths to the self-signed IdP certificate generated by `make certs`. |

Adjust these values before `make up` if you need a different host, port, or IdP metadata.

## Multi-Tenant Hosts

The IdP now detects the active tenant directly from the HTTP Host header. Set `SAMLIDP_HOSTNAME` to the base domain (for example `eduid.africa`) and each tenant will be served from `<tenant>.<base-domain>` automatically (e.g. `exampleidp.eduid.africa`). SimpleSAMLphp is configured with a dynamic base URL and a trusted domain allowlist derived from the request host, `SAMLIDP_HOSTNAME`, and any entries in `SAMLIDP_TRUSTED_DOMAINS` to prevent header spoofing.

Certificate material is resolved per-tenant from `certs/<tenant>/`. A helper script ships with the repo:

```bash
./scripts/gencerts.sh exampleidp.eduid.africa
```

The command above generates `certs/exampleidp.eduid.africa/idp.crt.pem` and `idp.key.pem` with the correct Subject Alternative Name. You can pass additional hostnames as extra arguments if a tenant needs multiple DNS names. Existing single-tenant deployments keep working because legacy `certs/idp.crt` and `certs/idp.key` files remain valid fallbacks.

## Testing Against an External SP

1. Run through the quick start commands above so the IdP is listening locally.
2. Visit http://localhost:8080/saml/metadata and download the XML.
3. Import that metadata into an external SP tester such as [samltest.id](https://samltest.id). The tester will use `SAML_IDP_ENTITY_ID` and `SAML_IDP_SSO_URL` directly.
4. Update `.env` to point `SAML_IDP_ENTITY_ID` / `SAML_IDP_SSO_URL` to routable addresses if you are testing off-machine, then restart with `make down && make up`.

The SSO endpoint currently returns a stub response clarifying how to wire a real SimpleSAMLphp flow; extend it as needed for end-to-end testing.

## Make Targets

| Target | Description |
|--------|-------------|
| `make env` | Copy `.env.example` to `.env` if it does not already exist. |
| `make certs` | Generate self-signed IdP cert/key into `certs/`. |
| `make tenant-cert host=exampleidp.eduid.africa` | Generate per-tenant cert/key in `certs/<tenant-host>/`. |
| `make up` | Build containers and start the stack (app + PostgreSQL). |
| `make down` | Stop containers and remove volumes. |
| `make logs` | Follow the application container logs. |
| `make sh` | Open an interactive shell inside the application container. |
| `make test` | Run the Symfony/PHPUnit test suite in Docker. |
| `make fmt` | Run PHP Code Beautifier (`phpcbf`) in Docker. |
| `make lint` | Run PHP_CodeSniffer (`phpcs`) in Docker. |

## Troubleshooting

- **Port 8080 already in use** – Change `APP_PORT` in `.env`, then rerun `make up`.
- **Database connection errors** – Ensure `POSTGRES_*` values match the database container. `docker compose logs db` shows server status.
- **Migrations fail** – Remove the database volume with `make down` (which drops volumes) and start again.
- **Certificates missing** – Run `make certs` for the default pair, or `./scripts/gencerts.sh <tenant-host>` to create per-tenant material under `certs/<tenant-host>/` before booting the stack.
- **Composer install problems** – Clean the Composer cache volume with `docker volume rm samlidp_composer-cache` and start again. Network access is required the first time dependencies are installed.

## Legacy Deployment Notes

The project previously documented a multi-service production setup with nginx, rsyslog, and wildcard certificates. Those instructions are preserved in the git history (`README.md` before this revision) if you need a reference for legacy deployments.

## Contributing & Donations

Pull requests and issue reports are welcome. If you find this project useful and would like to support ongoing work:

- BTC: `1NEvwJhgMeK4bSnRK8ir7v37B6ARhpUhYK`

*Thank you for your support and generosity!*
